# Как проверить систему обновления данных

## Быстрая проверка через консоль браузера

1. Откройте DevTools (F12)
2. Перейдите на вкладку Console
3. Выполните команду:

```javascript
SyncDebug.fullCheck()
```

Эта команда покажет:
- ✅ Структуру базы данных
- ✅ Состояние реестра синхронизации (sync_registry)
- ✅ Данные продаж и возвратов с флагами is_final

## Детальная проверка

### 1. Проверка структуры базы данных

В DevTools:
- Application → IndexedDB → WbAnalyticsDB
- Проверьте наличие таблиц:
  - `sales` (должно быть поле `is_final`)
  - `returns` (должно быть поле `is_final`)
  - `syncRegistry` (новая таблица для реестра синхронизации)
  - `syncLogs`

Или в консоли:
```javascript
SyncDebug.checkDatabaseStructure()
```

### 2. Проверка реестра синхронизации

Реестр отслеживает состояние синхронизации каждого периода:

```javascript
SyncDebug.checkSyncRegistry()
```

Проверьте:
- ✅ Есть ли записи в реестре после запуска синхронизации
- ✅ Статусы: `pending`, `waiting`, `success`, `failed`
- ✅ Типы: `daily`, `weekly`
- ✅ Флаг `isFinal` для недельных отчетов

### 3. Проверка данных с флагами is_final

```javascript
SyncDebug.checkSalesAndReturns()
```

Проверьте:
- ✅ Есть ли финальные данные (`is_final: true`)
- ✅ Есть ли временные данные (`is_final: false`)
- ✅ Для одной даты не должно быть одновременно финальных и временных данных

### 4. Ручная проверка через DevTools

#### Проверка таблицы sync_registry:

1. Application → IndexedDB → WbAnalyticsDB → syncRegistry
2. Проверьте записи:
   - `periodId` - идентификатор периода (формат: "2025-W01" для недель, "2025-01-15" для дней)
   - `type` - тип синхронизации: "daily" или "weekly"
   - `status` - статус: "pending", "waiting", "success", "failed"
   - `isFinal` - финальный ли отчет (только для weekly)
   - `nextRetryAt` - время следующего повтора (для статуса "waiting")
   - `lastAttempt` - время последней попытки

#### Проверка данных sales/returns:

1. Application → IndexedDB → WbAnalyticsDB → sales (или returns)
2. Проверьте поле `is_final`:
   - Для daily синхронизации: `is_final: false`
   - Для weekly синхронизации (финальный отчет): `is_final: true`

## Тестовые сценарии

### Тест 1: Первая синхронизация

1. Очистите реестр (опционально):
   ```javascript
   SyncDebug.clearSyncRegistry()
   ```

2. Запустите синхронизацию через UI

3. Проверьте реестр:
   ```javascript
   SyncDebug.checkSyncRegistry()
   ```

4. Ожидаемый результат:
   - В реестре появились записи со статусом `success` или `pending`
   - В таблицах sales/returns появились данные с `is_final: false` (daily) или `true` (weekly)

### Тест 2: Пустой ответ от API (waiting статус)

1. Запустите синхронизацию за сегодняшний день (если данных еще нет)

2. Проверьте реестр:
   ```javascript
   SyncDebug.checkSyncRegistry()
   ```

3. Ожидаемый результат:
   - Запись со статусом `waiting`
   - Поле `nextRetryAt` установлено (через 30 минут)

4. Через 30 минут проверьте снова - должна быть попытка повторной синхронизации

### Тест 3: Переход Daily → Weekly

1. Дождитесь daily синхронизации (данные с `is_final: false`)

2. Запустите weekly синхронизацию за ту же неделю

3. Проверьте данные:
   ```javascript
   SyncDebug.checkSalesAndReturns()
   ```

4. Ожидаемый результат:
   - Временные данные (`is_final: false`) удалены
   - Финальные данные (`is_final: true`) сохранены
   - В реестре запись с `isFinal: true`

### Тест 4: Обработка ошибок

1. Отключите интернет
2. Запустите синхронизацию
3. Проверьте реестр - должна быть запись со статусом `failed` с сообщением об ошибке

## Проверка логов синхронизации

В UI есть компонент `SyncLogMonitor`, который показывает логи в реальном времени:

1. Откройте страницу синхронизации
2. Запустите синхронизацию
3. Наблюдайте логи в мониторе

Или в консоли (если есть доступ к LoggerService):
```javascript
// Логи доступны через loggerService
```

## Типичные проблемы

### Проблема: Реестр не создается

**Решение:**
- Проверьте версию базы данных (должна быть версия 4)
- Очистите IndexedDB и перезагрузите страницу

### Проблема: Данные не обновляются

**Решение:**
- Проверьте статус в реестре
- Проверьте логи синхронизации
- Убедитесь, что API ключ корректный

### Проблема: Дублирование данных

**Решение:**
- Проверьте, что репозитории учитывают `is_final` при поиске дубликатов
- Убедитесь, что для одной даты нет одновременно финальных и временных данных

## Полезные команды

```javascript
// Полная проверка
SyncDebug.fullCheck()

// Проверка реестра
SyncDebug.checkSyncRegistry()

// Проверка данных
SyncDebug.checkSalesAndReturns()

// Проверка структуры БД
SyncDebug.checkDatabaseStructure()

// Очистить реестр (для тестирования)
SyncDebug.clearSyncRegistry()
```
